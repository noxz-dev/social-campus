<template>
  <header
    v-if="show && $route?.name !== 'Login' && $route?.name !== 'Register'"
    class="fixed bg-white dark:bg-dark-700 shadow-sm w-full lg:overflow-y-visible z-40"
  >
    <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
      <div class="relative flex justify-between xl:grid xl:grid-cols-12 lg:gap-8">
        <div class="flex md:absolute md:left-0 md:inset-y-0 lg:static xl:col-span-2">
          <div class="flex-shrink-0 flex items-center flex-row cursor-pointer" @click="$router.push('/home')">
            <svg
              class="h-6 lg:h-12 dark:fill-white fill-dark-800 mt-2"
              viewBox="0 0 681 286"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M44.4722 127.181C36.4054 127.181 29.1767 125.869 22.7861 123.246C16.3955 120.623 11.2621 116.74 7.38584 111.598C3.61435 106.456 1.62384 100.265 1.41431 93.0248H30.0148C30.4339 97.1172 31.8482 100.265 34.2577 102.469C36.6673 104.568 39.8102 105.617 43.6865 105.617C47.6675 105.617 50.8104 104.725 53.1152 102.941C55.42 101.052 56.5724 98.4814 56.5724 95.2284C56.5724 92.5001 55.6295 90.244 53.7438 88.4601C51.9628 86.6762 49.7104 85.2071 46.9865 84.0528C44.3674 82.8986 40.5959 81.5869 35.672 80.1178C28.5481 77.9141 22.7337 75.7105 18.2289 73.5069C13.724 71.3033 9.84779 68.0503 6.60011 63.7479C3.35244 59.4456 1.7286 53.8316 1.7286 46.9059C1.7286 36.6223 5.44771 28.5948 12.8859 22.8233C20.3242 16.947 30.0148 14.0088 41.9579 14.0088C54.1104 14.0088 63.9059 16.947 71.3441 22.8233C78.7823 28.5948 82.7633 36.6747 83.2871 47.0633H54.2152C54.0057 43.4955 52.6961 40.7147 50.2866 38.721C47.877 36.6223 44.7865 35.5729 41.015 35.5729C37.7673 35.5729 35.1482 36.4649 33.1577 38.2488C31.1672 39.9277 30.1719 42.3937 30.1719 45.6467C30.1719 49.2145 31.8482 51.9952 35.2006 53.989C38.553 55.9828 43.7912 58.1339 50.9152 60.4425C58.0391 62.856 63.8011 65.1646 68.2012 67.3682C72.706 69.5718 76.5823 72.7723 79.8299 76.9697C83.0776 81.1671 84.7014 86.5713 84.7014 93.1822C84.7014 99.4783 83.0776 105.197 79.8299 110.339C76.687 115.481 72.0774 119.573 66.0011 122.616C59.9248 125.66 52.7485 127.181 44.4722 127.181Z"
              />
              <path
                d="M141.154 127.338C132.563 127.338 124.81 125.502 117.896 121.829C111.086 118.157 105.691 112.91 101.71 106.089C97.8337 99.2684 95.8956 91.2933 95.8956 82.164C95.8956 73.1396 97.8861 65.217 101.867 58.3963C105.848 51.4706 111.296 46.1713 118.21 42.4986C125.125 38.8259 132.877 36.9895 141.468 36.9895C150.058 36.9895 157.811 38.8259 164.725 42.4986C171.64 46.1713 177.087 51.4706 181.068 58.3963C185.049 65.217 187.04 73.1396 187.04 82.164C187.04 91.1884 184.997 99.1635 180.911 106.089C176.93 112.91 171.43 118.157 164.411 121.829C157.497 125.502 149.744 127.338 141.154 127.338ZM141.154 104.043C146.287 104.043 150.635 102.154 154.197 98.3764C157.863 94.5988 159.697 89.1946 159.697 82.164C159.697 75.1334 157.916 69.7292 154.354 65.9516C150.897 62.1739 146.601 60.2851 141.468 60.2851C136.23 60.2851 131.882 62.1739 128.425 65.9516C124.968 69.6243 123.239 75.0284 123.239 82.164C123.239 89.1946 124.915 94.5988 128.268 98.3764C131.725 102.154 136.02 104.043 141.154 104.043Z"
              />
              <path
                d="M195.953 82.164C195.953 73.0347 197.786 65.0596 201.453 58.2389C205.225 51.4181 210.411 46.1713 217.011 42.4986C223.715 38.8259 231.363 36.9895 239.954 36.9895C250.954 36.9895 260.121 39.8753 267.454 45.6467C274.893 51.4181 279.764 59.5505 282.069 70.044H253.468C251.059 63.3282 246.397 59.9703 239.482 59.9703C234.559 59.9703 230.63 61.9116 227.697 65.7942C224.763 69.5718 223.296 75.0284 223.296 82.164C223.296 89.2996 224.763 94.8087 227.697 98.6913C230.63 102.469 234.559 104.358 239.482 104.358C246.397 104.358 251.059 101 253.468 94.284H282.069C279.764 104.568 274.893 112.648 267.454 118.524C260.016 124.4 250.849 127.338 239.954 127.338C231.363 127.338 223.715 125.502 217.011 121.829C210.411 118.157 205.225 112.91 201.453 106.089C197.786 99.2684 195.953 91.2933 195.953 82.164Z"
              />
              <path
                d="M309.957 29.1194C305.243 29.1194 301.367 27.7553 298.329 25.027C295.395 22.1937 293.928 18.7309 293.928 14.6384C293.928 10.441 295.395 6.97817 298.329 4.24986C301.367 1.41662 305.243 0 309.957 0C314.567 0 318.338 1.41662 321.272 4.24986C324.31 6.97817 325.829 10.441 325.829 14.6384C325.829 18.7309 324.31 22.1937 321.272 25.027C318.338 27.7553 314.567 29.1194 309.957 29.1194ZM323.315 38.2488V126.079H296.443V38.2488H323.315Z"
              />
              <path
                d="M337.445 82.0066C337.445 72.9822 339.122 65.0596 342.474 58.2389C345.931 51.4181 350.593 46.1713 356.46 42.4986C362.327 38.8259 368.875 36.9895 376.103 36.9895C382.284 36.9895 387.68 38.2488 392.289 40.7672C397.004 43.2856 400.618 46.5911 403.132 50.6835V38.2488H430.004V126.079H403.132V113.644C400.513 117.737 396.846 121.042 392.132 123.561C387.523 126.079 382.127 127.338 375.946 127.338C368.822 127.338 362.327 125.502 356.46 121.829C350.593 118.052 345.931 112.753 342.474 105.932C339.122 99.0061 337.445 91.031 337.445 82.0066ZM403.132 82.164C403.132 75.4482 401.247 70.149 397.475 66.2664C393.808 62.3838 389.303 60.4425 383.961 60.4425C378.618 60.4425 374.06 62.3838 370.289 66.2664C366.622 70.044 364.789 75.2908 364.789 82.0066C364.789 88.7224 366.622 94.0741 370.289 98.0616C374.06 101.944 378.618 103.886 383.961 103.886C389.303 103.886 393.808 101.944 397.475 98.0616C401.247 94.1791 403.132 88.8798 403.132 82.164Z"
              />
              <path d="M476.317 9.60155V126.079H449.445V9.60155H476.317Z" />
              <path
                d="M0 188.725C0 177.812 2.35718 168.106 7.07155 159.606C11.7859 151.001 18.3336 144.338 26.7147 139.616C35.2006 134.789 44.7865 132.375 55.4724 132.375C68.5678 132.375 79.7776 135.838 89.1015 142.764C98.4255 149.69 104.659 159.134 107.802 171.096H78.2585C76.0584 166.479 72.9155 162.964 68.8297 160.55C64.8487 158.137 60.2915 156.93 55.1581 156.93C46.8817 156.93 40.1769 159.816 35.0435 165.587C29.91 171.359 27.3433 179.071 27.3433 188.725C27.3433 198.379 29.91 206.092 35.0435 211.864C40.1769 217.635 46.8817 220.521 55.1581 220.521C60.2915 220.521 64.8487 219.314 68.8297 216.9C72.9155 214.487 76.0584 210.972 78.2585 206.354H107.802C104.659 218.317 98.4255 227.761 89.1015 234.687C79.7776 241.508 68.5678 244.918 55.4724 244.918C44.7865 244.918 35.2006 242.557 26.7147 237.835C18.3336 233.008 11.7859 226.345 7.07155 217.845C2.35718 209.345 0 199.639 0 188.725Z"
              />
              <path
                d="M118.915 200.058C118.915 191.034 120.591 183.111 123.944 176.291C127.401 169.47 132.063 164.223 137.93 160.55C143.796 156.878 150.344 155.041 157.573 155.041C163.754 155.041 169.149 156.3 173.759 158.819C178.473 161.337 182.087 164.643 184.602 168.735V156.3H211.474V244.131H184.602V231.696C181.983 235.789 178.316 239.094 173.602 241.613C168.992 244.131 163.597 245.39 157.416 245.39C150.292 245.39 143.796 243.554 137.93 239.881C132.063 236.103 127.401 230.804 123.944 223.983C120.591 217.058 118.915 209.083 118.915 200.058ZM184.602 200.216C184.602 193.5 182.716 188.201 178.945 184.318C175.278 180.436 170.773 178.494 165.43 178.494C160.087 178.494 155.53 180.436 151.758 184.318C148.092 188.096 146.258 193.342 146.258 200.058C146.258 206.774 148.092 212.126 151.758 216.113C155.53 219.996 160.087 221.937 165.43 221.937C170.773 221.937 175.278 219.996 178.945 216.113C182.716 212.231 184.602 206.932 184.602 200.216Z"
              />
              <path
                d="M342.802 155.356C353.697 155.356 362.34 158.662 368.731 165.272C375.226 171.883 378.474 181.065 378.474 192.818V244.131H351.759V196.438C351.759 190.772 350.24 186.417 347.202 183.374C344.269 180.226 340.183 178.652 334.945 178.652C329.706 178.652 325.568 180.226 322.53 183.374C319.597 186.417 318.13 190.772 318.13 196.438V244.131H291.415V196.438C291.415 190.772 289.896 186.417 286.858 183.374C283.925 180.226 279.839 178.652 274.601 178.652C269.363 178.652 265.224 180.226 262.186 183.374C259.253 186.417 257.786 190.772 257.786 196.438V244.131H230.914V156.3H257.786V167.319C260.51 163.646 264.072 160.76 268.472 158.662C272.872 156.458 277.848 155.356 283.401 155.356C290.001 155.356 295.868 156.773 301.001 159.606C306.239 162.439 310.325 166.479 313.259 171.726C316.297 166.899 320.435 162.964 325.673 159.921C330.911 156.878 336.621 155.356 342.802 155.356Z"
              />
              <path
                d="M424.139 168.735C426.759 164.643 430.373 161.337 434.983 158.819C439.592 156.3 444.987 155.041 451.169 155.041C458.397 155.041 464.945 156.878 470.812 160.55C476.678 164.223 481.288 169.47 484.641 176.291C488.098 183.111 489.826 191.034 489.826 200.058C489.826 209.083 488.098 217.058 484.641 223.983C481.288 230.804 476.678 236.103 470.812 239.881C464.945 243.554 458.397 245.39 451.169 245.39C445.092 245.39 439.697 244.131 434.983 241.613C430.373 239.094 426.759 235.841 424.139 231.854V286H397.268V156.3H424.139V168.735ZM462.483 200.058C462.483 193.342 460.597 188.096 456.826 184.318C453.159 180.436 448.602 178.494 443.154 178.494C437.811 178.494 433.254 180.436 429.482 184.318C425.816 188.201 423.982 193.5 423.982 200.216C423.982 206.932 425.816 212.231 429.482 216.113C433.254 219.996 437.811 221.937 443.154 221.937C448.497 221.937 453.054 219.996 456.826 216.113C460.597 212.126 462.483 206.774 462.483 200.058Z"
              />
              <path
                d="M590.511 156.3V244.131H563.639V232.168C560.915 236.051 557.196 239.199 552.482 241.613C547.872 243.921 542.739 245.075 537.082 245.075C530.377 245.075 524.458 243.606 519.324 240.668C514.191 237.625 510.21 233.27 507.381 227.604C504.553 221.937 503.138 215.274 503.138 207.614V156.3H529.853V203.993C529.853 209.87 531.372 214.434 534.41 217.687C537.448 220.94 541.534 222.567 546.668 222.567C551.906 222.567 556.044 220.94 559.082 217.687C562.12 214.434 563.639 209.87 563.639 203.993V156.3H590.511Z"
              />
              <path
                d="M645.485 245.39C637.837 245.39 631.028 244.079 625.056 241.455C619.085 238.832 614.37 235.264 610.913 230.752C607.456 226.135 605.518 220.993 605.099 215.326H631.656C631.971 218.369 633.385 220.835 635.899 222.724C638.414 224.613 641.504 225.558 645.171 225.558C648.523 225.558 651.09 224.928 652.871 223.669C654.757 222.305 655.7 220.573 655.7 218.474C655.7 215.956 654.39 214.12 651.771 212.965C649.152 211.706 644.909 210.342 639.042 208.873C632.756 207.404 627.518 205.882 623.328 204.308C619.137 202.629 615.523 200.058 612.485 196.595C609.446 193.028 607.927 188.253 607.927 182.272C607.927 177.235 609.289 172.67 612.013 168.578C614.842 164.38 618.927 161.075 624.27 158.662C629.718 156.248 636.161 155.041 643.599 155.041C654.6 155.041 663.243 157.77 669.528 163.226C675.919 168.683 679.586 175.923 680.529 184.948H655.7C655.281 181.905 653.919 179.491 651.614 177.707C649.414 175.923 646.48 175.031 642.814 175.031C639.671 175.031 637.261 175.661 635.585 176.92C633.909 178.074 633.071 179.701 633.071 181.8C633.071 184.318 634.38 186.207 636.999 187.466C639.723 188.725 643.914 189.985 649.571 191.244C656.066 192.923 661.357 194.602 665.443 196.281C669.528 197.855 673.09 200.478 676.128 204.151C679.271 207.719 680.895 212.546 681 218.632C681 223.774 679.533 228.391 676.6 232.483C673.771 236.471 669.633 239.619 664.185 241.927C658.842 244.236 652.609 245.39 645.485 245.39Z"
              />
            </svg>

            <!--<div
              v-if="breakpoints.is != 'md' && breakpoints.is != 'sm'"
              class="text-gray-900 dark:text-gray-50 ml-5 text-xl font-semibold"
            >
              SocialCampus
            </div> -->
          </div>
          <div
            v-if="breakpoints.is != 'sm' && breakpoints.is != 'md' && breakpoints.is != 'lg'"
            class="pl-28 font-bold text-xl flex-shrink-0 flex items-center dark:text-gray-50 text-gray-900"
          >
            <span v-if="user"></span>Hey {{ user?.firstname }} ðŸ‘‹
          </div>
        </div>
        <div class="min-w-0 flex-1 md:px-8 lg:px-0 xl:col-span-5 xl:col-start-5">
          <div class="flex items-center pl-2 md:pl-6 px-6 py-4 md:max-w-3xl md:mx-auto lg:max-w-none lg:mx-0 xl:px-0">
            <div class="w-full">
              <label for="search" class="sr-only">Search</label>
              <div class="relative">
                <div class="pointer-events-none absolute inset-y-0 left-0 pl-3 flex items-center"></div>
                <search class="h-8" />
              </div>
            </div>
          </div>
        </div>
        <div class="flex items-center md:absolute md:right-0 md:inset-y-0 lg:hidden dark:bg-dark-700 bg-white">
          <!-- Mobile menu button -->
          <button
            type="button"
            class="
              -mx-2
              rounded-md
              p-2
              inline-flex
              items-center
              justify-center
              bg-white
              dark:bg-dark-600
              text-gray-400
              hover:bg-gray-100
              dark:hover:bg-dark-700
              hover:text-gray-500
              focus:outline-none focus:ring-2 focus:ring-inset focus:ring-brand-500
            "
            aria-expanded="false"
            @click="openMobileMenu"
          >
            <span class="sr-only">Open menu</span>
            <svg
              class="block h-6 w-6 dark:text-gray-50 text-gray-900"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              aria-hidden="true"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
            <svg
              class="hidden h-6 w-6 dark:text-gray-50 text-gray-900"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              aria-hidden="true"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="hidden lg:flex lg:items-center lg:justify-end xl:col-span-3" id="notify-button" ref="notifyTarget">
          <div
            role="button"
            tabindex="0"
            @keydown.space="notifyOpen = !notifyOpen"
            @click="notifyOpen = !notifyOpen"
            class="
              hover:opacity-70
              relative
              cursor-pointer
              ml-5
              flex-shrink-0
              border-2 border-dark-800
              dark:border-gray-500
              rounded-full
              p-1
              py-2
              px-2
              text-gray-200
              hover:text-gray-500
              focus:outline-none
              dark:focus:ring-offset-dark-700
              focus:ring-2 focus:ring-offset-2 focus:ring-brand-500
            "
          >
            <span class="sr-only">View notifications</span>
            <svg
              viewBox="0 0 24 24"
              version="1.1"
              xmlns="http://www.w3.org/2000/svg"
              xmlns:xlink="http://www.w3.org/1999/xlink"
              class="h-8 dark:stroke-white stroke-black dark:fill-dark-600 fill-white"
            >
              <g
                id="Iconly/Light/Notification"
                stroke-width="1"
                fill-rule="evenodd"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <g id="Notification" transform="translate(3.500000, 2.000000)" stroke-width="1.5">
                  <path
                    d="M8.5,15.8476424 C14.13923,15.8476424 16.7480515,15.1242108 17,12.220506 C17,9.31879687 15.1811526,9.50539234 15.1811526,5.94511102 C15.1811526,3.16414015 12.5452291,-1.86517468e-14 8.5,-1.86517468e-14 C4.4547709,-1.86517468e-14 1.81884743,3.16414015 1.81884743,5.94511102 C1.81884743,9.50539234 0,9.31879687 0,12.220506 C0.252952291,15.135187 2.86177374,15.8476424 8.5,15.8476424 Z"
                    id="Stroke-1"
                  ></path>
                  <path
                    d="M10.8887931,18.8572176 C9.52465753,20.3719337 7.3966462,20.3898948 6.0194615,18.8572176"
                    id="Stroke-3"
                  ></path>
                </g>
              </g>
            </svg>
            <span
              v-if="notifications && notifications.length > 0"
              class="
                absolute
                top-0
                right-0
                block
                h-2.5
                w-2.5
                rounded-full
                ring-2 ring-white
                dark:ring-dark-700
                bg-green-400
              "
            />
          </div>

          <div class="relative" @click.stop>
            <transition name="fade">
              <notifications
                v-if="notifyOpen"
                @click.prevent
                @closeNotify="notifyOpen = false"
                @deleteNotification="deleteNotification($event)"
                :notifications="notifications"
              />
            </transition>
          </div>

          <!-- Profile dropdown -->
          <div class="flex-shrink-0 relative xl:ml-2 2xl:ml-5" ref="target">
            <div>
              <button
                id="user-menu"
                type="button"
                class="
                  p-1
                  rounded-full
                  flex
                  focus:outline-none focus:ring-2 focus:ring-offset-2
                  dark:focus:ring-offset-dark-700
                  focus:ring-brand-500
                "
                aria-haspopup="true"
                @click="showProfileMenu = !showProfileMenu"
              >
                <span class="sr-only">Open user menu</span>
                <div class="h-10 w-10 rounded-full">
                  <lazy-image
                    v-if="profileImage"
                    class="h-10 w-10 !rounded-full bg-dark-700 object-cover"
                    :src="profileImage"
                    :blurhash="user?.avatar.blurhash"
                    :onLoad="true"
                    rounded="full"
                  />
                </div>
              </button>
            </div>

            <transition name="fade">
              <div
                v-if="showProfileMenu"
                @click.stop
                class="
                  origin-top-right
                  absolute
                  z-10
                  right-0
                  mt-2
                  w-48
                  rounded-md
                  shadow-lg
                  bg-white
                  dark:bg-dark-800
                  ring-1 ring-black ring-opacity-5
                  border-dark-500 border
                "
                role="menu"
                aria-orientation="vertical"
                aria-labelledby="user-menu"
              >
                <button
                  class="flex items-center dark:hover:bg-dark-600 hover:bg-gray-100 transition duration-100 w-full"
                  @click="
                    () => {
                      if (user?.username) {
                        $router.push({
                          name: 'Profile',
                          params: {
                            id: user.username,
                          },
                        });
                      }

                      showProfileMenu = false;
                    }
                  "
                >
                  <svg
                    viewBox="0 0 24 24"
                    version="1.1"
                    xmlns="http://www.w3.org/2000/svg"
                    xmlns:xlink="http://www.w3.org/1999/xlink"
                    class="dark:stroke-white stroke-black h-6 ml-2"
                  >
                    <g
                      id="Iconly/Light/Profile"
                      stroke-width="1.5"
                      fill="none"
                      fill-rule="evenodd"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <g id="Profile" transform="translate(4.814286, 2.814476)">
                        <path
                          d="M7.17047619,12.531714 C3.30285714,12.531714 -4.08562073e-14,13.1164759 -4.08562073e-14,15.4583807 C-4.08562073e-14,17.8002854 3.28190476,18.4059997 7.17047619,18.4059997 C11.0380952,18.4059997 14.34,17.8202854 14.34,15.479333 C14.34,13.1383807 11.0590476,12.531714 7.17047619,12.531714 Z"
                          id="Stroke-1"
                          stroke-width="2"
                        ></path>
                        <path
                          d="M7.17047634,9.19142857 C9.70857158,9.19142857 11.7657144,7.13333333 11.7657144,4.5952381 C11.7657144,2.05714286 9.70857158,-5.32907052e-15 7.17047634,-5.32907052e-15 C4.6323811,-5.32907052e-15 2.574259,2.05714286 2.574259,4.5952381 C2.56571443,7.1247619 4.60952396,9.18285714 7.13809539,9.19142857 L7.17047634,9.19142857 Z"
                          id="Stroke-3"
                          stroke-width="2"
                        ></path>
                      </g>
                    </g>
                  </svg>
                  <div class="block py-2 px-4 text-sm dark:text-gray-100 text-gray-700" role="menuitem">
                    Dein Profil
                  </div>
                </button>
                <button
                  class="flex items-center dark:hover:bg-dark-600 hover:bg-gray-100 transition duration-100 w-full"
                  @click="$refs.settingsModal.openModal()"
                >
                  <!-- settings icon -->
                  <svg
                    viewBox="0 0 24 24"
                    version="1.1"
                    xmlns="http://www.w3.org/2000/svg"
                    xmlns:xlink="http://www.w3.org/1999/xlink"
                    class="h-6 ml-1.5 dark:stroke-white stroke-black"
                  >
                    <g
                      id="Iconly/Light/Setting"
                      stroke-width="1"
                      fill="none"
                      fill-rule="evenodd"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <g id="Setting" transform="translate(2.500000, 1.500000)" stroke-width="1.5">
                        <path
                          d="M18.3066362,6.12356982 L17.6842106,5.04347829 C17.1576365,4.12955711 15.9906873,3.8142761 15.0755149,4.33867279 L15.0755149,4.33867279 C14.6398815,4.59529992 14.1200613,4.66810845 13.6306859,4.54104256 C13.1413105,4.41397667 12.7225749,4.09747295 12.4668193,3.66132725 C12.3022855,3.38410472 12.2138742,3.06835005 12.2105264,2.74599544 L12.2105264,2.74599544 C12.2253694,2.22917739 12.030389,1.72835784 11.6700024,1.3576252 C11.3096158,0.986892553 10.814514,0.777818938 10.2974829,0.778031878 L9.04347831,0.778031878 C8.53694532,0.778031878 8.05129106,0.97987004 7.69397811,1.33890085 C7.33666515,1.69793166 7.13715288,2.18454839 7.13958814,2.69107553 L7.13958814,2.69107553 C7.12457503,3.73688099 6.27245786,4.57676682 5.22654465,4.57665906 C4.90419003,4.57331126 4.58843537,4.48489995 4.31121284,4.32036615 L4.31121284,4.32036615 C3.39604054,3.79596946 2.22909131,4.11125048 1.70251717,5.02517165 L1.03432495,6.12356982 C0.508388616,7.03634945 0.819378585,8.20256183 1.72997713,8.73226549 L1.72997713,8.73226549 C2.32188101,9.07399614 2.68650982,9.70554694 2.68650982,10.3890161 C2.68650982,11.0724852 2.32188101,11.704036 1.72997713,12.0457667 L1.72997713,12.0457667 C0.820534984,12.5718952 0.509205679,13.7352837 1.03432495,14.645309 L1.03432495,14.645309 L1.6659039,15.7345539 C1.9126252,16.1797378 2.3265816,16.5082503 2.81617164,16.6473969 C3.30576167,16.7865435 3.83061824,16.7248517 4.27459956,16.4759726 L4.27459956,16.4759726 C4.71105863,16.2212969 5.23116727,16.1515203 5.71931837,16.2821523 C6.20746948,16.4127843 6.62321383,16.7330005 6.87414191,17.1716248 C7.03867571,17.4488473 7.12708702,17.764602 7.13043482,18.0869566 L7.13043482,18.0869566 C7.13043482,19.1435014 7.98693356,20.0000001 9.04347831,20.0000001 L10.2974829,20.0000001 C11.3504633,20.0000001 12.2054882,19.1490783 12.2105264,18.0961099 L12.2105264,18.0961099 C12.2080776,17.5879925 12.4088433,17.0999783 12.7681408,16.7406809 C13.1274382,16.3813834 13.6154524,16.1806176 14.1235699,16.1830664 C14.4451523,16.1916732 14.7596081,16.2797208 15.0389017,16.4393593 L15.0389017,16.4393593 C15.9516813,16.9652957 17.1178937,16.6543057 17.6475973,15.7437072 L17.6475973,15.7437072 L18.3066362,14.645309 C18.5617324,14.2074528 18.6317479,13.6859659 18.5011783,13.1963297 C18.3706086,12.7066935 18.0502282,12.2893121 17.6109841,12.0366133 L17.6109841,12.0366133 C17.17174,11.7839145 16.8513595,11.3665332 16.7207899,10.876897 C16.5902202,10.3872608 16.6602358,9.86577384 16.9153319,9.42791767 C17.0812195,9.13829096 17.3213574,8.89815312 17.6109841,8.73226549 L17.6109841,8.73226549 C18.5161253,8.20284891 18.8263873,7.04344892 18.3066362,6.13272314 L18.3066362,6.13272314 L18.3066362,6.12356982 Z"
                          id="Path_33946"
                        ></path>
                        <circle id="Ellipse_737" cx="9.67505726" cy="10.3890161" r="2.63615562"></circle>
                      </g>
                    </g>
                  </svg>

                  <div class="block py-2 px-4 text-sm dark:text-gray-100 text-gray-700" role="menuitem">
                    Einstellungen
                  </div>
                </button>
                <div
                  class="
                    flex
                    items-center
                    justify-center
                    dark:hover:bg-dark-600
                    hover:bg-gray-100
                    transition
                    duration-100
                  "
                ></div>
                <button
                  class="
                    flex
                    items-center
                    dark:hover:bg-dark-600
                    hover:bg-gray-100
                    transition
                    duration-100
                    cursor-pointer
                    w-full
                  "
                >
                  <svg
                    width="24px"
                    height="24px"
                    viewBox="0 0 24 24"
                    version="1.1"
                    xmlns="http://www.w3.org/2000/svg"
                    xmlns:xlink="http://www.w3.org/1999/xlink"
                    class="h-6 ml-2 dark:stroke-white stroke-black"
                  >
                    <g
                      id="Iconly/Light/Logout"
                      stroke-width="1"
                      fill="none"
                      fill-rule="evenodd"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <g id="Logout" transform="translate(2.000000, 2.000000)" stroke-width="1.5">
                        <path
                          d="M13.016,5.3895 L13.016,4.4565 C13.016,2.4215 11.366,0.7715 9.331,0.7715 L4.456,0.7715 C2.422,0.7715 0.772,2.4215 0.772,4.4565 L0.772,15.5865 C0.772,17.6215 2.422,19.2715 4.456,19.2715 L9.341,19.2715 C11.37,19.2715 13.016,17.6265 13.016,15.5975 L13.016,14.6545"
                          id="Stroke-1"
                        ></path>
                        <line x1="19.8095" y1="10.0214" x2="7.7685" y2="10.0214" id="Stroke-3"></line>
                        <polyline id="Stroke-5" points="16.8812 7.1063 19.8092 10.0213 16.8812 12.9373"></polyline>
                      </g>
                    </g>
                  </svg>
                  <div class="block py-2 px-4 text-sm dark:text-gray-100 text-gray-700" role="menuitem" @click="logout">
                    Ausloggen
                  </div>
                </button>
              </div>
            </transition>
          </div>

          <app-button
            v-if="['Home', 'Browse'].includes($route.name)"
            class="xl:ml-2 2xl:ml-6"
            @click="modal.openModal()"
          >
            Neuer Post
            <svg
              viewBox="0 0 24 24"
              version="1.1"
              xmlns="http://www.w3.org/2000/svg"
              xmlns:xlink="http://www.w3.org/1999/xlink"
              class="ml-2 h-6 w-6"
            >
              <g id="Iconly/Bulk/Send" stroke="none" stroke-width="1" fill-rule="evenodd">
                <g id="Send" transform="translate(2.000000, 2.000000)" fill-rule="nonzero">
                  <path
                    d="M19.4274202,0.578298605 C18.9274202,0.0672986048 18.1874202,-0.121701395 17.4974202,0.0782986048 L1.40742017,4.7272986 C0.679420165,4.9292986 0.163420165,5.5062986 0.024420165,6.2382986 C-0.117579835,6.9842986 0.378420165,7.9322986 1.02642017,8.3282986 L6.05742017,11.4002986 C6.57342017,11.7162986 7.23942017,11.6372986 7.66642017,11.2092986 L13.4274202,5.4482986 C13.7174202,5.1472986 14.1974202,5.1472986 14.4874202,5.4482986 C14.7774202,5.7372986 14.7774202,6.2082986 14.4874202,6.5082986 L8.71642017,12.2692986 C8.28842017,12.6972986 8.20842017,13.3612986 8.52342017,13.8782986 L11.5974202,18.9282986 C11.9574202,19.5272986 12.5774202,19.8682986 13.2574202,19.8682986 C13.3374202,19.8682986 13.4274202,19.8682986 13.5074202,19.8572986 C14.2874202,19.7582986 14.9074202,19.2272986 15.1374202,18.4772986 L19.9074202,2.5082986 C20.1174202,1.8282986 19.9274202,1.0882986 19.4274202,0.578298605"
                    id="Fill-1"
                    class="fill-white"
                  ></path>
                  <path
                    d="M7.45142017,17.1421986 C7.74342017,17.4351986 7.74342017,17.9101986 7.45142017,18.2031986 L6.08542017,19.5681986 C5.93942017,19.7151986 5.74742017,19.7881986 5.55542017,19.7881986 C5.36342017,19.7881986 5.17142017,19.7151986 5.02542017,19.5681986 C4.73242017,19.2751986 4.73242017,18.8011986 5.02542017,18.5081986 L6.39042017,17.1421986 C6.68342017,16.8501986 7.15842017,16.8501986 7.45142017,17.1421986 Z M6.66772017,13.3541986 C6.95972017,13.6471986 6.95972017,14.1221986 6.66772017,14.4151986 L5.30172017,15.7801986 C5.15572017,15.9271986 4.96372017,16.0001986 4.77172017,16.0001986 C4.57972017,16.0001986 4.38772017,15.9271986 4.24172017,15.7801986 C3.94872017,15.4871986 3.94872017,15.0131986 4.24172017,14.7201986 L5.60672017,13.3541986 C5.89972017,13.0621986 6.37472017,13.0621986 6.66772017,13.3541986 Z M2.90652017,12.1617986 C3.19852017,12.4547986 3.19852017,12.9297986 2.90652017,13.2227986 L1.54052017,14.5877986 C1.39452017,14.7347986 1.20252017,14.8077986 1.01052017,14.8077986 C0.818520165,14.8077986 0.626520165,14.7347986 0.480520165,14.5877986 C0.187520165,14.2947986 0.187520165,13.8207986 0.480520165,13.5277986 L1.84552017,12.1617986 C2.13852017,11.8697986 2.61352017,11.8697986 2.90652017,12.1617986 Z"
                    id="Combined-Shape"
                    opacity="0.400000006"
                    class="fill-white"
                  ></path>
                </g>
              </g>
            </svg>
          </app-button>
          <div v-if="$route.name === 'Group'">
            <group-permission-container :groupId="$route.params.id">
              <template v-slot:onlyMember>
                <app-button class="ml-6" @click="modal.openModal()">
                  Neuer Post
                  <svg
                    viewBox="0 0 24 24"
                    version="1.1"
                    xmlns="http://www.w3.org/2000/svg"
                    xmlns:xlink="http://www.w3.org/1999/xlink"
                    class="ml-2 h-6 w-6"
                  >
                    <g id="Iconly/Bulk/Send" stroke="none" stroke-width="1" fill-rule="evenodd">
                      <g id="Send" transform="translate(2.000000, 2.000000)" fill-rule="nonzero">
                        <path
                          d="M19.4274202,0.578298605 C18.9274202,0.0672986048 18.1874202,-0.121701395 17.4974202,0.0782986048 L1.40742017,4.7272986 C0.679420165,4.9292986 0.163420165,5.5062986 0.024420165,6.2382986 C-0.117579835,6.9842986 0.378420165,7.9322986 1.02642017,8.3282986 L6.05742017,11.4002986 C6.57342017,11.7162986 7.23942017,11.6372986 7.66642017,11.2092986 L13.4274202,5.4482986 C13.7174202,5.1472986 14.1974202,5.1472986 14.4874202,5.4482986 C14.7774202,5.7372986 14.7774202,6.2082986 14.4874202,6.5082986 L8.71642017,12.2692986 C8.28842017,12.6972986 8.20842017,13.3612986 8.52342017,13.8782986 L11.5974202,18.9282986 C11.9574202,19.5272986 12.5774202,19.8682986 13.2574202,19.8682986 C13.3374202,19.8682986 13.4274202,19.8682986 13.5074202,19.8572986 C14.2874202,19.7582986 14.9074202,19.2272986 15.1374202,18.4772986 L19.9074202,2.5082986 C20.1174202,1.8282986 19.9274202,1.0882986 19.4274202,0.578298605"
                          id="Fill-1"
                          class="fill-white"
                        ></path>
                        <path
                          d="M7.45142017,17.1421986 C7.74342017,17.4351986 7.74342017,17.9101986 7.45142017,18.2031986 L6.08542017,19.5681986 C5.93942017,19.7151986 5.74742017,19.7881986 5.55542017,19.7881986 C5.36342017,19.7881986 5.17142017,19.7151986 5.02542017,19.5681986 C4.73242017,19.2751986 4.73242017,18.8011986 5.02542017,18.5081986 L6.39042017,17.1421986 C6.68342017,16.8501986 7.15842017,16.8501986 7.45142017,17.1421986 Z M6.66772017,13.3541986 C6.95972017,13.6471986 6.95972017,14.1221986 6.66772017,14.4151986 L5.30172017,15.7801986 C5.15572017,15.9271986 4.96372017,16.0001986 4.77172017,16.0001986 C4.57972017,16.0001986 4.38772017,15.9271986 4.24172017,15.7801986 C3.94872017,15.4871986 3.94872017,15.0131986 4.24172017,14.7201986 L5.60672017,13.3541986 C5.89972017,13.0621986 6.37472017,13.0621986 6.66772017,13.3541986 Z M2.90652017,12.1617986 C3.19852017,12.4547986 3.19852017,12.9297986 2.90652017,13.2227986 L1.54052017,14.5877986 C1.39452017,14.7347986 1.20252017,14.8077986 1.01052017,14.8077986 C0.818520165,14.8077986 0.626520165,14.7347986 0.480520165,14.5877986 C0.187520165,14.2947986 0.187520165,13.8207986 0.480520165,13.5277986 L1.84552017,12.1617986 C2.13852017,11.8697986 2.61352017,11.8697986 2.90652017,12.1617986 Z"
                          id="Combined-Shape"
                          opacity="0.400000006"
                          class="fill-white"
                        ></path>
                      </g>
                    </g>
                  </svg>
                </app-button>
              </template>
            </group-permission-container>
          </div>
        </div>
      </div>
    </div>
    <nav class="lg:hidden" :class="showMobileMenu ? 'block' : 'hidden'" aria-label="Global">
      <div class="border-t border-dark-600 pt-4 pb-3">
        <div class="max-w-3xl mx-auto px-4 flex items-center sm:px-6">
          <div class="flex-shrink-0 h-10 w-10">
            <lazy-image
              v-if="user?.avatar"
              class="h-10 w-10 rounded-full"
              :src="profileImage"
              alt=""
              rounded="full"
              :blurhash="user?.avatar.blurhash"
            />
          </div>
          <div class="ml-3">
            <div class="text-base font-medium dark:text-gray-50 text-gray-800">
              <span v-if="user"> {{ user?.firstname + ' ' + user?.lastname }}</span>
            </div>
            <div class="text-sm font-medium dark:text-gray-400 text-gray-500">
              <span v-if="user"> @{{ user?.username }}</span>
            </div>
          </div>
          <button
            ref="mobileNotifyTarget"
            type="button"
            class="
              ml-auto
              flex-shrink-0
              dark:bg-dark-700
              bg-white
              rounded-full
              p-1
              text-gray-400
              hover:text-highlight-500
              focus:outline-none focus:ring-2 focus:ring-offset-2
              dark:focus:ring-offset-dark-700
              focus:ring-brand-500
            "
          >
            <span class="sr-only">View notifications</span>
            <svg
              @click="
                () => {
                  notifyOpen = !notifyOpen;
                }
              "
              class="h-6 w-6"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
              />
            </svg>
            <transition name="fade">
              <notifications
                class="!w-full mt-4 mobileNotify z-50"
                v-if="notifyOpen"
                @click.prevent
                @closeNotify="notifyOpen = false"
                @deleteNotification="deleteNotification($event)"
                :notifications="notifications"
              />
            </transition>
          </button>
        </div>
        <div class="mt-3 max-w-3xl mx-auto px-2 space-y-1 sm:px-4 block">
          <div
            @click="
              () => {
                if (user?.username) {
                  $router.push({
                    name: 'Profile',
                    params: {
                      id: user?.username,
                    },
                  });
                }
                showMobileMenu = false;
              }
            "
            class="
              block
              rounded-md
              py-2
              px-3
              text-base
              font-medium
              dark:text-gray-50
              text-gray-500
              hover:bg-gray-50 hover:text-gray-900
              dark:hover:text-gray-50 dark:hover:bg-dark-600
            "
          >
            Dein Profil
          </div>

          <div
            @click="$refs.settingsModal.openModal()"
            class="
              block
              rounded-md
              py-2
              px-3
              text-base
              font-medium
              dark:text-gray-50
              text-gray-500
              hover:bg-gray-50 hover:text-gray-900
              dark:hover:text-gray-50 dark:hover:bg-dark-600
            "
          >
            Einstellungen
          </div>

          <div
            @click="logout"
            class="
              block
              rounded-md
              py-2
              px-3
              text-base
              font-medium
              dark:text-gray-50
              text-gray-500
              hover:bg-gray-50 hover:text-gray-900
              dark:hover:text-gray-50 dark:hover:bg-dark-600
            "
          >
            Ausloggen
          </div>
        </div>
      </div>
    </nav>
  </header>

  <floating-button
    v-if="['Home', 'Browse'].includes($route.name) && !notifyOpen && !state.showNewPostFloatingButton"
    class="lg:hidden sm:block"
    text="Neuer Post"
    @click="modal.openModal()"
  />
  <div v-if="$route.name === 'Group' && !notifyOpen">
    <group-permission-container :groupId="$route.params.id">
      <template v-slot:onlyMember>
        <floating-button
          v-if="['Group'].includes($route.name)"
          class="lg:hidden sm:block"
          text="Neuer Post"
          @click="modal.openModal()"
        />
      </template>
    </group-permission-container>
  </div>
  <modal ref="modal" content-text="" header-text="Neuer Post">
    <new-post @close="modal.closeModal()" />
  </modal>
  <modal ref="settingsModal" content-text="" header-text="Einstellungen">
    <settings-modal @close="settingsModal.closeModal()" />
  </modal>
  <edit-modal content-text="" header-text="Edit Post" />
</template>

<script lang="ts">
import { defineComponent, ref } from 'vue';
import Modal from '../components/Modal.vue';
import NewPost from './Post/NewPost.vue';
import EditPost from './Post/EditPost.vue';
import breakpoints from '../utils/breakpoints';
import { useGetNotificationsQuery, useLogoutMutation, useMeQuery } from '../graphql/generated/types';
import { useResult } from '@vue/apollo-composable';
import { onLogout } from '../apollo';
import { onClickOutside } from '@vueuse/core';
import { useStore } from 'vuex';
import { useRouter } from 'vue-router';
import FloatingButton from './Form/FloatingButton.vue';
import Search from './Search.vue';
import Notifications from './Notifications.vue';
import EditModal from './Post/EditModal.vue';
import ToggleButton from './Form/ToggleButton.vue';
import { notificationsSubscription } from '../graphql/subscriptions/notifications';
import { Notification } from '../graphql/generated/types';
import GroupPermissionContainer from './Group/GroupPermissionContainer.vue';
import { RecursivePartial } from '../utils/typeUtils';
import LazyImage from './Blurhash/LazyImage.vue';
import SettingsModal from './SettingsModal.vue';
import { state } from '../utils/state';

export default defineComponent({
  components: {
    Modal,
    NewPost,
    FloatingButton,
    Search,
    Notifications,
    EditModal,
    EditPost,
    ToggleButton,
    GroupPermissionContainer,
    LazyImage,
    SettingsModal,
  },
  setup() {
    const showProfileMenu = ref(false);
    const showMobileMenu = ref(false);
    const show = ref(true);
    const target = ref(null);
    const router = useRouter();
    const notifyOpen = ref(false);
    const notifyTarget = ref(null);
    const mobileNotifyTarget = ref(null);
    const notifications = ref<RecursivePartial<Notification>[]>([]);
    const store = useStore();
    const modal = ref<InstanceType<typeof Modal>>();
    const settingsModal = ref<InstanceType<typeof Modal>>();

    //close the profile menu, on click outside
    onClickOutside(target, (event) => {
      showProfileMenu.value = false;
    });

    //close the notifcation, on click outside
    onClickOutside(notifyTarget, (event) => {
      if (notifyOpen.value && !showMobileMenu.value) {
        notifyOpen.value = false;
        showMobileMenu.value = false;
      }
    });

    //close the mobile notifciation menu, on click outside
    onClickOutside(mobileNotifyTarget, (event) => {
      if (notifyOpen.value && showMobileMenu.value) {
        notifyOpen.value = false;
        showMobileMenu.value = false;
      }
    });

    const { result, error, onResult } = useMeQuery();

    const user = useResult(result, null, (data) => data.me);
    const profileImage = ref('');

    //gets the logged in user, and sets it to the global store
    onResult(({ data: { me } }) => {
      store.dispatch('userData/setUser', me);
      profileImage.value = me?.avatar.name || '';

      const { onResult: onNotifications, subscribeToMore, loading: notificationsLoading } = useGetNotificationsQuery();
      subscribeToMore(() => ({
        document: notificationsSubscription,
        variables: {
          userId: me?.id,
        },
        updateQuery(prev, { subscriptionData: { data } }) {
          //update the exisiting data with new from the subscription
          return Object.assign({}, prev, {
            getNotifications: [data, ...prev.getNotifications],
          });
        },
      }));

      onNotifications(({ data }) => {
        notifications.value = data.getNotifications;
      });
    });

    /**
     * deletes an notification by id
     */
    const deleteNotification = (id: string) => {
      notifications.value = notifications.value.filter((n) => n.id != id);
    };

    profileImage.value = user?.value?.avatar.name || '';

    const openMobileMenu = () => {
      showMobileMenu.value = !showMobileMenu.value;
    };

    const { mutate: logoutUser } = useLogoutMutation(() => ({
      variables: {
        token: localStorage.getItem('apollo-token')!,
      },
    }));

    /**
     * logs the user out
     */
    const logout = async () => {
      try {
        await logoutUser();
      } catch (err) {
        console.log('logout failed', err);
      }
      await router.go(0);
      onLogout();
    };

    return {
      target,
      logout,
      show,
      showProfileMenu,
      user,
      breakpoints,
      openMobileMenu,
      showMobileMenu,
      profileImage,
      notifyOpen,
      notifyTarget,
      mobileNotifyTarget,
      notifications,
      deleteNotification,
      modal,
      state,
      settingsModal,
    };
  },
});
</script>

<style>
.text-indent {
  text-indent: 10px;
}

.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.2s ease;
}

.fade-enter-from,
.fade-leave-to {
  opacity: 0;
}

.mobileNotify {
  height: calc(100vh - 125px) !important;
}
</style>
