<template>
  <div class="flex justify-center items-center h-full w-full">
    <div
      class="
        md:min-h-screen
        bg-gray-50
        dark:bg-dark-700
        flex flex-col
        justify-center
        py-26
        md:py-12
        sm:px-6
        lg:px-8
        w-full
      "
    >
      <div class="sm:mx-auto sm:w-full sm:max-w-md lg:max-w-lg flex flex-col justify-center">
        <svg
          class="h-24 lg:h-28 dark:fill-white fill-dark-800"
          viewBox="0 0 681 286"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M44.4722 127.181C36.4054 127.181 29.1767 125.869 22.7861 123.246C16.3955 120.623 11.2621 116.74 7.38584 111.598C3.61435 106.456 1.62384 100.265 1.41431 93.0248H30.0148C30.4339 97.1172 31.8482 100.265 34.2577 102.469C36.6673 104.568 39.8102 105.617 43.6865 105.617C47.6675 105.617 50.8104 104.725 53.1152 102.941C55.42 101.052 56.5724 98.4814 56.5724 95.2284C56.5724 92.5001 55.6295 90.244 53.7438 88.4601C51.9628 86.6762 49.7104 85.2071 46.9865 84.0528C44.3674 82.8986 40.5959 81.5869 35.672 80.1178C28.5481 77.9141 22.7337 75.7105 18.2289 73.5069C13.724 71.3033 9.84779 68.0503 6.60011 63.7479C3.35244 59.4456 1.7286 53.8316 1.7286 46.9059C1.7286 36.6223 5.44771 28.5948 12.8859 22.8233C20.3242 16.947 30.0148 14.0088 41.9579 14.0088C54.1104 14.0088 63.9059 16.947 71.3441 22.8233C78.7823 28.5948 82.7633 36.6747 83.2871 47.0633H54.2152C54.0057 43.4955 52.6961 40.7147 50.2866 38.721C47.877 36.6223 44.7865 35.5729 41.015 35.5729C37.7673 35.5729 35.1482 36.4649 33.1577 38.2488C31.1672 39.9277 30.1719 42.3937 30.1719 45.6467C30.1719 49.2145 31.8482 51.9952 35.2006 53.989C38.553 55.9828 43.7912 58.1339 50.9152 60.4425C58.0391 62.856 63.8011 65.1646 68.2012 67.3682C72.706 69.5718 76.5823 72.7723 79.8299 76.9697C83.0776 81.1671 84.7014 86.5713 84.7014 93.1822C84.7014 99.4783 83.0776 105.197 79.8299 110.339C76.687 115.481 72.0774 119.573 66.0011 122.616C59.9248 125.66 52.7485 127.181 44.4722 127.181Z"
          />
          <path
            d="M141.154 127.338C132.563 127.338 124.81 125.502 117.896 121.829C111.086 118.157 105.691 112.91 101.71 106.089C97.8337 99.2684 95.8956 91.2933 95.8956 82.164C95.8956 73.1396 97.8861 65.217 101.867 58.3963C105.848 51.4706 111.296 46.1713 118.21 42.4986C125.125 38.8259 132.877 36.9895 141.468 36.9895C150.058 36.9895 157.811 38.8259 164.725 42.4986C171.64 46.1713 177.087 51.4706 181.068 58.3963C185.049 65.217 187.04 73.1396 187.04 82.164C187.04 91.1884 184.997 99.1635 180.911 106.089C176.93 112.91 171.43 118.157 164.411 121.829C157.497 125.502 149.744 127.338 141.154 127.338ZM141.154 104.043C146.287 104.043 150.635 102.154 154.197 98.3764C157.863 94.5988 159.697 89.1946 159.697 82.164C159.697 75.1334 157.916 69.7292 154.354 65.9516C150.897 62.1739 146.601 60.2851 141.468 60.2851C136.23 60.2851 131.882 62.1739 128.425 65.9516C124.968 69.6243 123.239 75.0284 123.239 82.164C123.239 89.1946 124.915 94.5988 128.268 98.3764C131.725 102.154 136.02 104.043 141.154 104.043Z"
          />
          <path
            d="M195.953 82.164C195.953 73.0347 197.786 65.0596 201.453 58.2389C205.225 51.4181 210.411 46.1713 217.011 42.4986C223.715 38.8259 231.363 36.9895 239.954 36.9895C250.954 36.9895 260.121 39.8753 267.454 45.6467C274.893 51.4181 279.764 59.5505 282.069 70.044H253.468C251.059 63.3282 246.397 59.9703 239.482 59.9703C234.559 59.9703 230.63 61.9116 227.697 65.7942C224.763 69.5718 223.296 75.0284 223.296 82.164C223.296 89.2996 224.763 94.8087 227.697 98.6913C230.63 102.469 234.559 104.358 239.482 104.358C246.397 104.358 251.059 101 253.468 94.284H282.069C279.764 104.568 274.893 112.648 267.454 118.524C260.016 124.4 250.849 127.338 239.954 127.338C231.363 127.338 223.715 125.502 217.011 121.829C210.411 118.157 205.225 112.91 201.453 106.089C197.786 99.2684 195.953 91.2933 195.953 82.164Z"
          />
          <path
            d="M309.957 29.1194C305.243 29.1194 301.367 27.7553 298.329 25.027C295.395 22.1937 293.928 18.7309 293.928 14.6384C293.928 10.441 295.395 6.97817 298.329 4.24986C301.367 1.41662 305.243 0 309.957 0C314.567 0 318.338 1.41662 321.272 4.24986C324.31 6.97817 325.829 10.441 325.829 14.6384C325.829 18.7309 324.31 22.1937 321.272 25.027C318.338 27.7553 314.567 29.1194 309.957 29.1194ZM323.315 38.2488V126.079H296.443V38.2488H323.315Z"
          />
          <path
            d="M337.445 82.0066C337.445 72.9822 339.122 65.0596 342.474 58.2389C345.931 51.4181 350.593 46.1713 356.46 42.4986C362.327 38.8259 368.875 36.9895 376.103 36.9895C382.284 36.9895 387.68 38.2488 392.289 40.7672C397.004 43.2856 400.618 46.5911 403.132 50.6835V38.2488H430.004V126.079H403.132V113.644C400.513 117.737 396.846 121.042 392.132 123.561C387.523 126.079 382.127 127.338 375.946 127.338C368.822 127.338 362.327 125.502 356.46 121.829C350.593 118.052 345.931 112.753 342.474 105.932C339.122 99.0061 337.445 91.031 337.445 82.0066ZM403.132 82.164C403.132 75.4482 401.247 70.149 397.475 66.2664C393.808 62.3838 389.303 60.4425 383.961 60.4425C378.618 60.4425 374.06 62.3838 370.289 66.2664C366.622 70.044 364.789 75.2908 364.789 82.0066C364.789 88.7224 366.622 94.0741 370.289 98.0616C374.06 101.944 378.618 103.886 383.961 103.886C389.303 103.886 393.808 101.944 397.475 98.0616C401.247 94.1791 403.132 88.8798 403.132 82.164Z"
          />
          <path d="M476.317 9.60155V126.079H449.445V9.60155H476.317Z" />
          <path
            d="M0 188.725C0 177.812 2.35718 168.106 7.07155 159.606C11.7859 151.001 18.3336 144.338 26.7147 139.616C35.2006 134.789 44.7865 132.375 55.4724 132.375C68.5678 132.375 79.7776 135.838 89.1015 142.764C98.4255 149.69 104.659 159.134 107.802 171.096H78.2585C76.0584 166.479 72.9155 162.964 68.8297 160.55C64.8487 158.137 60.2915 156.93 55.1581 156.93C46.8817 156.93 40.1769 159.816 35.0435 165.587C29.91 171.359 27.3433 179.071 27.3433 188.725C27.3433 198.379 29.91 206.092 35.0435 211.864C40.1769 217.635 46.8817 220.521 55.1581 220.521C60.2915 220.521 64.8487 219.314 68.8297 216.9C72.9155 214.487 76.0584 210.972 78.2585 206.354H107.802C104.659 218.317 98.4255 227.761 89.1015 234.687C79.7776 241.508 68.5678 244.918 55.4724 244.918C44.7865 244.918 35.2006 242.557 26.7147 237.835C18.3336 233.008 11.7859 226.345 7.07155 217.845C2.35718 209.345 0 199.639 0 188.725Z"
          />
          <path
            d="M118.915 200.058C118.915 191.034 120.591 183.111 123.944 176.291C127.401 169.47 132.063 164.223 137.93 160.55C143.796 156.878 150.344 155.041 157.573 155.041C163.754 155.041 169.149 156.3 173.759 158.819C178.473 161.337 182.087 164.643 184.602 168.735V156.3H211.474V244.131H184.602V231.696C181.983 235.789 178.316 239.094 173.602 241.613C168.992 244.131 163.597 245.39 157.416 245.39C150.292 245.39 143.796 243.554 137.93 239.881C132.063 236.103 127.401 230.804 123.944 223.983C120.591 217.058 118.915 209.083 118.915 200.058ZM184.602 200.216C184.602 193.5 182.716 188.201 178.945 184.318C175.278 180.436 170.773 178.494 165.43 178.494C160.087 178.494 155.53 180.436 151.758 184.318C148.092 188.096 146.258 193.342 146.258 200.058C146.258 206.774 148.092 212.126 151.758 216.113C155.53 219.996 160.087 221.937 165.43 221.937C170.773 221.937 175.278 219.996 178.945 216.113C182.716 212.231 184.602 206.932 184.602 200.216Z"
          />
          <path
            d="M342.802 155.356C353.697 155.356 362.34 158.662 368.731 165.272C375.226 171.883 378.474 181.065 378.474 192.818V244.131H351.759V196.438C351.759 190.772 350.24 186.417 347.202 183.374C344.269 180.226 340.183 178.652 334.945 178.652C329.706 178.652 325.568 180.226 322.53 183.374C319.597 186.417 318.13 190.772 318.13 196.438V244.131H291.415V196.438C291.415 190.772 289.896 186.417 286.858 183.374C283.925 180.226 279.839 178.652 274.601 178.652C269.363 178.652 265.224 180.226 262.186 183.374C259.253 186.417 257.786 190.772 257.786 196.438V244.131H230.914V156.3H257.786V167.319C260.51 163.646 264.072 160.76 268.472 158.662C272.872 156.458 277.848 155.356 283.401 155.356C290.001 155.356 295.868 156.773 301.001 159.606C306.239 162.439 310.325 166.479 313.259 171.726C316.297 166.899 320.435 162.964 325.673 159.921C330.911 156.878 336.621 155.356 342.802 155.356Z"
          />
          <path
            d="M424.139 168.735C426.759 164.643 430.373 161.337 434.983 158.819C439.592 156.3 444.987 155.041 451.169 155.041C458.397 155.041 464.945 156.878 470.812 160.55C476.678 164.223 481.288 169.47 484.641 176.291C488.098 183.111 489.826 191.034 489.826 200.058C489.826 209.083 488.098 217.058 484.641 223.983C481.288 230.804 476.678 236.103 470.812 239.881C464.945 243.554 458.397 245.39 451.169 245.39C445.092 245.39 439.697 244.131 434.983 241.613C430.373 239.094 426.759 235.841 424.139 231.854V286H397.268V156.3H424.139V168.735ZM462.483 200.058C462.483 193.342 460.597 188.096 456.826 184.318C453.159 180.436 448.602 178.494 443.154 178.494C437.811 178.494 433.254 180.436 429.482 184.318C425.816 188.201 423.982 193.5 423.982 200.216C423.982 206.932 425.816 212.231 429.482 216.113C433.254 219.996 437.811 221.937 443.154 221.937C448.497 221.937 453.054 219.996 456.826 216.113C460.597 212.126 462.483 206.774 462.483 200.058Z"
          />
          <path
            d="M590.511 156.3V244.131H563.639V232.168C560.915 236.051 557.196 239.199 552.482 241.613C547.872 243.921 542.739 245.075 537.082 245.075C530.377 245.075 524.458 243.606 519.324 240.668C514.191 237.625 510.21 233.27 507.381 227.604C504.553 221.937 503.138 215.274 503.138 207.614V156.3H529.853V203.993C529.853 209.87 531.372 214.434 534.41 217.687C537.448 220.94 541.534 222.567 546.668 222.567C551.906 222.567 556.044 220.94 559.082 217.687C562.12 214.434 563.639 209.87 563.639 203.993V156.3H590.511Z"
          />
          <path
            d="M645.485 245.39C637.837 245.39 631.028 244.079 625.056 241.455C619.085 238.832 614.37 235.264 610.913 230.752C607.456 226.135 605.518 220.993 605.099 215.326H631.656C631.971 218.369 633.385 220.835 635.899 222.724C638.414 224.613 641.504 225.558 645.171 225.558C648.523 225.558 651.09 224.928 652.871 223.669C654.757 222.305 655.7 220.573 655.7 218.474C655.7 215.956 654.39 214.12 651.771 212.965C649.152 211.706 644.909 210.342 639.042 208.873C632.756 207.404 627.518 205.882 623.328 204.308C619.137 202.629 615.523 200.058 612.485 196.595C609.446 193.028 607.927 188.253 607.927 182.272C607.927 177.235 609.289 172.67 612.013 168.578C614.842 164.38 618.927 161.075 624.27 158.662C629.718 156.248 636.161 155.041 643.599 155.041C654.6 155.041 663.243 157.77 669.528 163.226C675.919 168.683 679.586 175.923 680.529 184.948H655.7C655.281 181.905 653.919 179.491 651.614 177.707C649.414 175.923 646.48 175.031 642.814 175.031C639.671 175.031 637.261 175.661 635.585 176.92C633.909 178.074 633.071 179.701 633.071 181.8C633.071 184.318 634.38 186.207 636.999 187.466C639.723 188.725 643.914 189.985 649.571 191.244C656.066 192.923 661.357 194.602 665.443 196.281C669.528 197.855 673.09 200.478 676.128 204.151C679.271 207.719 680.895 212.546 681 218.632C681 223.774 679.533 228.391 676.6 232.483C673.771 236.471 669.633 239.619 664.185 241.927C658.842 244.236 652.609 245.39 645.485 245.39Z"
          />
        </svg>
      </div>

      <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-md lg:max-w-lg">
        <div
          class="
            bg-white
            py-8
            px-4
            shadow
            sm:rounded-lg
            sm:px-10
            md:dark:bg-dark-600
            dark:bg-dark-700
            border
            md:dark:border-dark-600
            dark:border-dark-700
          "
        >
          <form class="space-y-6" action="#" method="POST" @submit.prevent="onSubmit({ email, password })">
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-50"> Email </label>
              <div class="mt-1">
                <input
                  id="email"
                  name="email"
                  type="email"
                  placeholder="example@email.com"
                  v-model="emailForm"
                  autocomplete="email"
                  required
                  class="
                    appearance-none
                    block
                    w-full
                    px-3
                    py-2
                    border
                    dark:text-gray-100
                    dark:bg-dark-700
                    dark:border-dark-600
                    border-gray-300
                    rounded-md
                    shadow-sm
                    placeholder-gray-400
                    focus:outline-none
                    focus:ring-brand-500
                    focus:border-indigo-500
                    sm:text-sm
                  "
                />
              </div>
            </div>

            <div>
              <label for="password" class="block text-sm font-medium dark:text-gray-50 text-gray-700"> Passwort </label>
              <div class="mt-1">
                <input
                  id="password"
                  placeholder="Passwort"
                  v-model="password"
                  name="password"
                  type="password"
                  autocomplete="current-password"
                  required
                  class="
                    appearance-none
                    block
                    w-full
                    px-3
                    py-2
                    border
                    dark:text-gray-100
                    dark:bg-dark-700
                    dark:border-dark-600
                    border-gray-300
                    rounded-md
                    shadow-sm
                    placeholder-gray-400
                    focus:outline-none
                    focus:ring-brand-500
                    focus:border-indigo-500
                    sm:text-sm
                  "
                />
              </div>
            </div>

            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <div v-for="(error, index) in v.$errors" :key="index" class="text-red-500">
                  {{ error.$message }}
                  {{}}
                </div>
              </div>
            </div>

            <div>
              <button
                type="submit"
                class="
                  w-full
                  flex
                  justify-center
                  py-2
                  px-4
                  border border-transparent
                  rounded-md
                  shadow-sm
                  text-sm
                  font-medium
                  text-white
                  bg-brand-600
                  hover:bg-brand-700
                  focus:outline-none
                  focus:ring-2 focus:ring-offset-2 focus:ring-brand-500
                "
              >
                Login
              </button>
            </div>
          </form>
          <div class="flex justify-center dark:text-gray-50 text-gray-900 mt-3 text-sm">
            <div class="flex">
              <div>Neu hier ?</div>
              <div
                tabindex="0"
                role="button"
                class="text-highlight-500 underline cursor-pointer ml-2"
                @click="$router.push('/signup')"
                @keydown="$router.push('/signup')"
              >
                Konto erstellen
              </div>
            </div>
          </div>
        </div>
        <div
          v-if="error && error?.message.includes('activated')"
          class="bg-red-500 h-10 text-white rounded-xl p-2 px-10 absolute my-0 mt-5 left-1/2 transform -translate-x-1/2"
        >
          Dein Account ist nicht aktiviert
        </div>
        <div
          v-else-if="error"
          class="bg-red-500 h-10 text-white rounded-xl p-2 px-10 absolute my-0 mt-5 left-1/2 transform -translate-x-1/2"
        >
          Falsche E-Mail oder Passwort!
        </div>
      </div>
    </div>
  </div>
</template>

<script lang="ts">
import { computed, defineComponent, ref } from 'vue';
import { required, minLength, email, helpers } from '@vuelidate/validators';
import useVuelidate from '@vuelidate/core';
import { useMutation } from '@vue/apollo-composable';
import { login as loginMutation } from '../../graphql/mutations/login';
import { useRoute, useRouter } from 'vue-router';
export default defineComponent({
  setup() {
    const router = useRouter();
    const route = useRoute();
    const emailForm = ref('');
    const password = ref('');

    const validEmail = (value) => value.endsWidth('@hs-hannover.de');

    //input validation rules
    const rules = computed(() => ({
      emailForm: {
        required: helpers.withMessage('Email wird benötigt', required),
        email: helpers.withMessage('Keine gültige Email', email),
        // validEmail: helpers.withMessage('Nur Hochschul-Emails sind erlaubt', validEmail)
      },
      password: {
        required: helpers.withMessage('Passwort wird benötigt', required),
        minLength: helpers.withMessage('Das Passwort muss mindestens 5 Zeichen lang sein', minLength(5)),
      },
    }));

    const v = useVuelidate(rules, { emailForm, password });

    //create login mutation
    const {
      mutate: login,
      onDone,
      error,
    } = useMutation(loginMutation, () => ({
      variables: {
        email: emailForm.value,
        password: password.value,
      },
    }));

    /**
     * validates the input and loggs the user in
     */
    const onSubmit = async () => {
      await v.value.$validate();
      if (!v.value.$invalid) {
        await login();
      }
    };

    onDone((result) => {
      localStorage.setItem('apollo-token', result.data.login.accessToken);
      router.push(route.query.redirect || '/');
    });

    return { onSubmit, emailForm, password, error, v };
  },
});
</script>

<style></style>
